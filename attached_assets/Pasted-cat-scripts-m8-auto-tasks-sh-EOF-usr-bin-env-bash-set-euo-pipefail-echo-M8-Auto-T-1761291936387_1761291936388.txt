cat > scripts/m8_auto_tasks.sh << 'EOF'
#!/usr/bin/env bash
set -euo pipefail

echo "== ğŸ¢ M8 Auto Tasks: go.guimashan.org.tw å…¨é¢è‡ªæª¢ =="

########################################
# 0. åŸºæœ¬è¨­å®š
########################################

DOMAIN="https://go.guimashan.org.tw"

# é€™ä¸‰å€‹ä¸€å®šè¦å·²ç¶“åœ¨ Replit Secrets è£¡ç¶å¥½
FIREBASE_JSON="${FIREBASE_SERVICE_ACCOUNT_JSON:-}"
DEPLOY_HOOK="${VERCEL_DEPLOY_HOOK_URL:-}"
BASE_URL="${NEXT_PUBLIC_BASE_URL:-}"

########################################
# 1. æª¢æŸ¥ç’°å¢ƒè®Šæ•¸
########################################

echo ""
echo "== 1. ç’°å¢ƒè®Šæ•¸æª¢æŸ¥ =="

missing=0

if [ -z "$FIREBASE_JSON" ]; then
  echo "âŒ FIREBASE_SERVICE_ACCOUNT_JSON æ²’æœ‰è¨­åˆ°ç’°å¢ƒè®Šæ•¸ï¼ˆReplit Secretsï¼‰"
  missing=1
else
  # æˆ‘å€‘åªå°å‡º project_idï¼Œä¸å°ç§é‘°
  project_id=$(echo "$FIREBASE_JSON" | sed 's/"/\n/g' | grep '^project_id:' | sed 's/project_id://')
  if [ -z "$project_id" ]; then
    # fallback ç”¨ jq-like çš„åœŸæ³• (å› ç‚ºä¸èƒ½ç”¨jq)
    project_id=$(echo "$FIREBASE_JSON" | sed 's/[{},]/\n/g' | grep '"project_id"' | sed 's/.*"project_id":[[:space:]]*"\([^"]*\)".*/\1/')
  fi

  echo "âœ… FIREBASE_SERVICE_ACCOUNT_JSON å·²è¨­ç½®"
  echo "   â†’ project_id = ${project_id:-"(è®€ä¸åˆ° project_id)"}"

  # æœŸæœ›æ˜¯ checkin-76c77
  if echo "$FIREBASE_JSON" | grep -q "checkin-76c77"; then
    echo "   âœ” ä½¿ç”¨ checkin-76c77 âœ…"
  else
    echo "   âš  WARNING: çœ‹èµ·ä¾†ä¸æ˜¯ checkin-76c77ï¼Œè«‹ç¢ºèªå·²åˆ‡åˆ°æ­£ç¢º Firestore å°ˆæ¡ˆ"
  fi
fi

if [ -z "$BASE_URL" ]; then
  echo "âŒ NEXT_PUBLIC_BASE_URL æ²’æœ‰è¨­"
  missing=1
else
  echo "âœ… NEXT_PUBLIC_BASE_URL = $BASE_URL"
  if [ "$BASE_URL" != "$DOMAIN" ]; then
    echo "   âš  WARNING: BASE_URL ä¸æ˜¯ $DOMAINï¼Œè«‹ç¢ºèªæ˜¯å¦æ•…æ„çš„"
  fi
fi

if [ -z "$DEPLOY_HOOK" ]; then
  echo "âŒ VERCEL_DEPLOY_HOOK_URL æ²’æœ‰è¨­ï¼ˆä¹‹å¾Œç„¡æ³•è‡ªå‹•è§¸ç™¼æ­£å¼ç«™é‡å»ºï¼‰"
  missing=1
else
  echo "âœ… VERCEL_DEPLOY_HOOK_URL å·²å°±ç·’ï¼ˆä¸é¡¯ç¤ºå…§å®¹ï¼‰"
fi

if [ "$missing" -eq 1 ]; then
  echo ""
  echo "ğŸ’¥ æœ‰ç¼ºç’°å¢ƒè®Šæ•¸ï¼Œè«‹å…ˆè£œå¥½ Secrets å†è·‘ã€‚è…³æœ¬çµæŸã€‚"
  exit 1
fi

########################################
# 2. å¥åº·æª¢æŸ¥ API
########################################

echo ""
echo "== 2. å¥åº·æª¢æŸ¥ API =="

echo "--> æ¸¬è©¦ /api/ping-bot"
ping_bot_resp=$(curl -s "$DOMAIN/api/ping-bot" || true)
echo "    å›å‚³: $ping_bot_resp"
if echo "$ping_bot_resp" | grep -q '"ok":true'; then
  echo "    âœ… ping-bot OK"
else
  echo "    âŒ ping-bot ä¼¼ä¹ä¸æ­£å¸¸ï¼Œè«‹æª¢æŸ¥ LINE bot config"
fi

echo "--> æ¸¬è©¦ /api/ping-admin"
ping_admin_resp=$(curl -s "$DOMAIN/api/ping-admin" || true)
echo "    å›å‚³: $ping_admin_resp"
if echo "$ping_admin_resp" | grep -q '"ok":true'; then
  echo "    âœ… ping-admin OK"
else
  echo "    âŒ ping-admin ä¼¼ä¹ä¸æ­£å¸¸ï¼Œè«‹æª¢æŸ¥ Firebase Admin é‡‘é‘° / å°ˆæ¡ˆ"
fi

########################################
# 3. Git ç‹€æ…‹åŒæ­¥å› GitHub
########################################

echo ""
echo "== 3. Git ç‹€æ…‹åŒæ­¥åˆ° GitHub =="

# æˆ‘å€‘ä¸åœ¨é€™è£¡è‡ªå‹• push --forceï¼Œé¿å…æŠŠéŒ¯çš„æ±è¥¿æ´—ä¸Šå»
# å¦‚æœå·¥ä½œæ¨¹æ˜¯ä¹¾æ·¨çš„ï¼Œå°±è·³é commitï¼›å¦‚æœæœ‰æ”¹å‹•ï¼Œå°± commit+push

if [ -n "$(git status --porcelain)" ]; then
  echo "ğŸ“¦ åµæ¸¬åˆ°æœ¬åœ°æœ‰å°šæœªæäº¤çš„è®Šæ›´ â†’ é€²è¡Œ commit & push"

  git add .
  git commit -m "M8 sync: ensure checkin-76c77 Firebase config, healthcheck verified"
  # push æœƒéœ€è¦å·²ç¶“æœ‰æ†‘è­‰ (Replit ç›®å‰æœ‰è¨­å®š PAT)
  git push origin main || echo "âš  push å¤±æ•—ï¼Œè«‹æ‰‹å‹• push"
else
  echo "âœ… æ²’æœ‰æœ¬åœ°è®Šæ›´ï¼Œç•¥é commit/push"
fi

########################################
# 4. è§¸ç™¼ Vercel æ­£å¼ç«™é‡å»º
########################################

echo ""
echo "== 4. è§¸ç™¼ Vercel æ­£å¼ç«™é‡æ–°éƒ¨ç½² =="

curl -fsSL -X POST "$DEPLOY_HOOK" >/dev/null 2>&1 \
  && echo "ğŸš€ å·²è§¸ç™¼ Vercel Deploy Hookï¼Œæ­£å¼ç«™æ­£åœ¨é‡å»ºä¸­" \
  || echo "âš  ç„¡æ³•è§¸ç™¼ Deploy Hookï¼Œè«‹æ‰‹å‹•åœ¨ Vercel Dashboard -> Deployments é» 'Redeploy'"

########################################
# 5. ç¸½çµ
########################################

echo ""
echo "== 5. ç¸½çµç‹€æ…‹ =="
echo "âœ” ç’°å¢ƒè®Šæ•¸æª¢æŸ¥å®Œæˆ (åŒ…å« checkin-76c77)"
echo "âœ” /api/ping-bot / /api/ping-admin å›æ‡‰å·²åˆ—å‡º"
echo "âœ” GitHub åŒæ­¥å˜—è©¦å®Œæˆ"
echo "âœ” å·²å˜—è©¦è§¸ç™¼ Vercel æ­£å¼éƒ¨ç½²"
echo ""
echo "ğŸ¯ å®Œæˆ M8 Auto Tasks"
EOF

chmod +x scripts/m8_auto_tasks.sh
echo "âœ… è…³æœ¬å·²å¯«å…¥ scripts/m8_auto_tasks.sh"
echo "ğŸ‘‰ ä¹‹å¾Œåªè¦åŸ·è¡Œï¼šbash scripts/m8_auto_tasks.sh"