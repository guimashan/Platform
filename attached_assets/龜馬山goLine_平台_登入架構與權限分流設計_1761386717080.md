
# 🏗️ 龜馬山 goLine 平台 — 登入架構與權限分流設計（正式版）

## 一、整體設計概念
龜馬山 goLine 平台整合 **LIFF（LINE Front-end Framework）** 與 **LINE Login（OAuth 2.0）**，依使用情境分為「前台服務」與「後台管理」兩大入口。

---

## 二、架構總覽

| 類型 | 登入方式 | 主要用途 | 使用者角色 | 裝置環境 |
|------|------------|-----------|--------------|-----------|
| **前台（LIFF）** | LINE App 內登入（LIFF SDK） | 日常作業（簽到、排班、神服服務） | user、poweruser、admin、superadmin | 行動裝置（LINE 內） |
| **後台（LINE Login）** | OAuth 2.0 登入（外部瀏覽器） | 系統管理、報表匯出、設定巡邏點、角色管理 | poweruser、admin、superadmin | 桌機 / 平板瀏覽器 |

---

## 三、角色與權限對照表

| 角色 | 說明 | 可使用 LIFF 前台 | 可使用 LINE Login 後台 | 權限摘要 |
|------|------|------------------|-------------------------|-----------|
| **user** | 一般使用者 / 志工 / 工作同仁 | ✅ 排班、簽到、神服服務 | ❌ 無法登入後台 | 只能執行個人操作，不具管理權 |
| **poweruser** | 管理者 / 幹部 | ✅ 可簽到或查看前台狀況 | ✅ 可查看紀錄、匯出報表 | 只能查詢資料，無法修改設定 |
| **admin** | 系統管理者 | ✅ 可執行前台任務 | ✅ 可管理巡邏點 / 使用者 | 系統維護與管理操作 |
| **superadmin** | 最高系統管理者 | ✅ 可執行前台任務 | ✅ 完整後台權限（含角色設定） | 擁有最高控制權 |

---

## 四、登入分流架構

### 1️⃣ LIFF（前台入口）
- 登入角色：`user`、`poweruser`、`admin`、`superadmin`
- 導向頁面：
  - `/checkin/index.html` — 奉香簽到系統
  - `/schedule/index.html` — 排班系統
  - `/service/index.html` — 神服服務（點燈 / 法會報名 / 香油錢）
- 特性：
  - 在 LINE App 內開啟，不需跳轉外部瀏覽器
  - 自動取得 LINE 使用者資料（`liff.getProfile()`）
  - 前台行為皆與 Firebase 同步

### 2️⃣ LINE Login（後台入口）
- 登入角色：`poweruser`、`admin`、`superadmin`
- 導向頁面：
  - `/checkin/admin/index.html` — 簽到紀錄查詢、匯出
  - `/checkin/admin/patrols.html` — 巡邏點管理、QR Code 產生
  - `/checkin/admin/users.html` — 使用者 / 角色管理
  - （未來）`/schedule/admin/`、`/service/admin/` 等模組後台
- 特性：
  - 使用 OAuth 授權流程
  - 登入後取得 access token，再向 Firebase 驗證
  - 可跨裝置使用（桌機、平板、手機瀏覽器）

---

## 五、角色權限摘要（整合矩陣）

| 功能 / 頁面 | user | poweruser | admin | superadmin |
|--------------|------|-----------|--------|-------------|
| **奉香簽到（LIFF）** | ✅ | ✅ | ✅ | ✅ |
| **排班系統（LIFF）** | ✅ | ✅ | ✅ | ✅ |
| **神服服務（LIFF）** | ✅ | ✅ | ✅ | ✅ |
| **查看簽到紀錄（後台）** | ❌ | ✅ | ✅ | ✅ |
| **匯出報表** | ❌ | ✅ | ✅ | ✅ |
| **巡邏點管理** | ❌ | ❌ | ✅ | ✅ |
| **使用者管理（角色設定）** | ❌ | ❌ | ✅ | ✅（含變更 admin/superadmin） |
| **角色授權管理** | ❌ | ❌ | ✅（不含超管） | ✅（含超管） |

---

## 六、技術實作重點

1. **共用使用者資料**
   ```js
   users = {
     uid: "LINE_USER_ID",
     displayName: "王大明",
     pictureUrl: "...",
     role: "user" | "poweruser" | "admin" | "superadmin",
     lastLoginAt: Timestamp,
     createdAt: Timestamp
   }
   ```
   - 首次登入自動建立帳號，預設 `role = "user"`
   - 若已有資料則更新登入時間

2. **前端權限防護**
   ```js
   if (role === 'user') {
     alert('您沒有後台權限');
     window.location.href = '/checkin/index.html';
   }
   ```

3. **登入方式區分**
   - **LIFF 使用：**
     ```js
     await liff.init({ liffId: "XXXX" });
     const profile = await liff.getProfile();
     ```
   - **LINE Login 使用：**
     ```js
     GET https://access.line.me/oauth2/v2.1/authorize?response_type=code...
     → 取得 code → 換取 token → 取 user info → Firebase 紀錄
     ```

---

## 七、結論（摘要）

| 模組 | 登入方式 | 使用角色 | 範例頁面 |
|------|-----------|-----------|-----------|
| 奉香簽到 / 排班 / 神服服務 | **LIFF** | 全角色可用 | `/checkin/index.html`、`/schedule/index.html`、`/service/index.html` |
| 後台管理（查詢 / 匯出 / 設定） | **LINE Login** | poweruser↑ | `/checkin/admin/...`、`/schedule/admin/...`、`/service/admin/...` |

---

## 八、整合示意圖（v3）

**LIFF（前台） →** 排班、簽到、神服服務  
**LINE Login（後台） →** 管理頁（查詢、匯出、設定）

> 🔹 user：只能使用 LIFF  
> 🔹 poweruser / admin / superadmin：可用 LIFF + LINE Login  
> 🔹 superadmin：擁有所有後台權限
