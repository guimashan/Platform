# 0) é€²åˆ°å°ˆæ¡ˆæ ¹ç›®éŒ„
cd ~/workspace

# 1) æº–å‚™è…³æœ¬
mkdir -p scripts

cat > scripts/m7_vercel_webhook.sh <<'BASH'
#!/usr/bin/env bash
set -euo pipefail

# ====== å¯èª¿åƒæ•¸ ======
DOMAIN="${DOMAIN:-go.guimashan.org.tw}"          # æ­£å¼ç¶²åŸŸï¼ˆå¯æ”¹ï¼‰
PROJECT_SLUG="platform"                          # Vercel å°ˆæ¡ˆåï¼ˆè³‡è¨Šç”¨ï¼‰
WEBHOOK_URL="https://${DOMAIN}/api/webhook"

# ====== å¾ Replit Secrets å–ç”¨ ======
TOKEN="${VERCEL_ADMIN_API_KEY:-}"
LINE_ID="${LINE_BOT_CHANNEL_ID:-}"
LINE_TOKEN="${LINE_BOT_ACCESS_TOKEN:-}"
DEPLOY_HOOK="${VERCEL_DEPLOY_HOOK_URL:-}"

# ====== æª¢æŸ¥å¿…è¦ç’°å¢ƒ ======
[[ -n "$TOKEN"     ]] || { echo "âŒ ç¼ºå°‘ VERCEL_ADMIN_API_KEY"; exit 1; }
[[ -n "$LINE_ID"   ]] || { echo "âŒ ç¼ºå°‘ LINE_BOT_CHANNEL_ID"; exit 1; }
[[ -n "$LINE_TOKEN"]] || { echo "âŒ ç¼ºå°‘ LINE_BOT_ACCESS_TOKEN"; exit 1; }

echo "== ğŸ§© M7 ä»»å‹™ï¼šVercel æ­£å¼ç’°å¢ƒ + LINE Webhook åŒæ­¥ =="

# 1) è§¸ç™¼ Vercel Deployï¼ˆå¦‚æœæœ‰è¨­å®š Deploy Hookï¼‰
if [[ -n "${DEPLOY_HOOK}" ]]; then
  echo "== ğŸš€ è§¸ç™¼ Vercel Deploy Hook =="
  curl -fsS -X POST "$DEPLOY_HOOK" >/dev/null || true
else
  echo "âš ï¸ æœªè¨­å®š VERCEL_DEPLOY_HOOK_URLï¼Œç•¥éè‡ªå‹•éƒ¨ç½²ã€‚"
fi

# 2) æ›´æ–° LINE Webhook æŒ‡åˆ°æ­£å¼ç¶²åŸŸ
echo "== ğŸ”§ æ›´æ–° LINE Webhook åˆ°ï¼š${WEBHOOK_URL} =="
curl -fsS -X PUT "https://api.line.me/v2/bot/channel/webhook/endpoint" \
  -H "Authorization: Bearer ${LINE_TOKEN}" \
  -H "Content-Type: application/json" \
  -d "{\"endpoint\":\"${WEBHOOK_URL}\"}" >/dev/null

# 3) è®€å–ç›®å‰ Webhook ç‹€æ…‹ï¼ˆç´”é¡¯ç¤ºï¼‰
echo "== ğŸ” è®€å– LINE Webhook ç‹€æ…‹ =="
curl -fsS -X GET "https://api.line.me/v2/bot/channel/webhook/endpoint" \
  -H "Authorization: Bearer ${LINE_TOKEN}" || true
echo

# 4) å¥åº·æª¢æŸ¥ï¼ˆ/api/ping-bot èˆ‡ /api/ping-adminï¼‰
echo "== ğŸ©º API å¥åº·æª¢æŸ¥ =="
for PATH in "/api/ping-bot" "/api/ping-admin"; do
  URL="https://${DOMAIN}${PATH}"
  CODE="$(curl -s -o /dev/null -w "%{http_code}" "$URL" || echo 000)"
  echo "â€¢ ${URL} -> HTTP ${CODE}"
done

# 5) å¯«å…¥é©—æ”¶å ±å‘Šï¼ˆä¸ push åˆ° GitHubï¼Œé¿å… Secret Scan æ“‹ä¸‹ï¼‰
echo "== ğŸ“ å¯«å…¥é©—æ”¶å ±å‘Šï¼ˆæœ¬åœ° ACCEPTANCE_REPORT.mdï¼‰ =="
DATE="$(date -u '+%Y-%m-%d %H:%M:%S UTC')"
{
  echo ""
  echo "## M7 æ­£å¼ç’°å¢ƒéƒ¨ç½²ï¼ˆ${DATE})"
  echo "- Vercel å°ˆæ¡ˆï¼š${PROJECT_SLUG}"
  echo "- æ­£å¼ç¶²åŸŸï¼š${DOMAIN}"
  echo "- LINE Webhookï¼š${WEBHOOK_URL}"
} >> ACCEPTANCE_REPORT.md

echo "== âœ… M7 å®Œæˆï¼šè«‹åˆ° LINE Developers â†’ Messaging API â†’ Webhook settings æŒ‰ Verify ç¢ºèª =="
BASH

chmod +x scripts/m7_vercel_webhook.sh

# 2) åŸ·è¡Œï¼ˆå¦‚éœ€æ”¹æ­£å¼ç¶²åŸŸï¼Œå¯åœ¨å‰é¢åŠ  DOMAIN=xxxï¼‰
DOMAIN=go.guimashan.org.tw ./scripts/m7_vercel_webhook.sh