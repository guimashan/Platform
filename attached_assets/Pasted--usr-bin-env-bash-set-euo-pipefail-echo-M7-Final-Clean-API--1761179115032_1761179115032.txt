#!/usr/bin/env bash
set -euo pipefail

echo "== M7-Final Cleanï¼šç§»é™¤èˆŠ API â†’ ç¢ºä¿ç’°å¢ƒ â†’ è§¸ç™¼éƒ¨ç½² â†’ å¥åº·æª¢æŸ¥ =="

# ====== 0) åƒæ•¸ ======
PROJECT="${PROJECT:-platform}"
BRANCH="${BRANCH:-main}"
DOMAIN="${DOMAIN:-go.guimashan.org.tw}"

# Vercel å¿…è¦åƒæ•¸ï¼ˆè«‹å…ˆåœ¨ Replit Secrets è¨­å¥½ï¼‰
: "${VERCEL_PROJECT_ID:?ç¼ºå°‘ VERCEL_PROJECT_ID}"
: "${VERCEL_ADMIN_API_KEY:?ç¼ºå°‘ VERCEL_ADMIN_API_KEY}"
# å¯é¸ï¼šè‹¥æ²’æœ‰ Deploy Hookï¼ŒVercel æœƒè‡ªå‹•å¾ GitHub éƒ¨ç½²
: "${VERCEL_DEPLOY_HOOK_URL:=}"

# ====== 1) ç§»é™¤èˆŠ API ç«¯é»ï¼ˆå› ç‚ºå·²ç æ‰é‡ç·´ï¼Œçµ±ä¸€èµ° LIFF ä¸»ç·šï¼‰======
echo "â€” ç§»é™¤ legacy APIï¼š/api/loginã€/api/checkinã€/api/checkin/manage"
rm -rf src/app/api/login || true
rm -rf src/app/api/checkin || true
rm -rf src/app/api/checkin/manage || true

git add -A
if ! git diff --cached --quiet; then
  git commit -m "chore(m7): remove legacy OAuth/checkin endpoints; migrate fully to LIFF mainline"
  git push origin "$BRANCH"
  echo "âœ” å·²æ¨é€åˆ° GitHubï¼š$BRANCH"
else
  echo "â„¹ï¸ ç„¡æª”æ¡ˆè®Šæ›´å¯æäº¤ï¼ˆå¯èƒ½ä¹‹å‰å·²æ¸…éï¼‰"
fi

# ====== 2) ç¢ºä¿ Vercel æœ‰ NEXT_PUBLIC_BASE_URL ======
echo "â€” æª¢æŸ¥/å»ºç«‹ Vercel ç’°å¢ƒè®Šæ•¸ï¼šNEXT_PUBLIC_BASE_URL=https://${DOMAIN}"
CREATE_ENV_PAYLOAD=$(cat <<JSON
{
  "key": "NEXT_PUBLIC_BASE_URL",
  "value": "https://${DOMAIN}",
  "target": ["production", "preview", "development"],
  "type": "plain"
}
JSON
)

# å˜—è©¦å»ºç«‹ï¼ˆè‹¥å·²å­˜åœ¨æœƒ 409ï¼Œä¸å½±éŸ¿ï¼‰
set +e
RESP=$(curl -sS -X POST "https://api.vercel.com/v10/projects/${VERCEL_PROJECT_ID}/env" \
  -H "Authorization: Bearer ${VERCEL_ADMIN_API_KEY}" \
  -H "Content-Type: application/json" \
  -d "$CREATE_ENV_PAYLOAD")
CODE=$?
set -e
if [ $CODE -eq 0 ]; then
  echo "âœ” Vercel è®Šæ•¸æäº¤æˆåŠŸï¼ˆè‹¥å·²å­˜åœ¨å‰‡å¿½ç•¥ï¼‰"
else
  echo "âš ï¸ Vercel è®Šæ•¸æäº¤å‡ºç¾éè‡´å‘½éŒ¯èª¤ï¼ˆå¯èƒ½å·²å­˜åœ¨ï¼‰ï¼Œç¹¼çºŒæµç¨‹"
fi

# ====== 3) è§¸ç™¼éƒ¨ç½²ï¼ˆè‹¥æœ‰ Hookï¼‰======
if [ -n "${VERCEL_DEPLOY_HOOK_URL}" ]; then
  echo "â€” è§¸ç™¼ Vercel Deploy Hook"
  curl -fsSL -X POST "$VERCEL_DEPLOY_HOOK_URL" >/dev/null && echo "âœ” å·²è§¸ç™¼éƒ¨ç½²"
else
  echo "â„¹ï¸ æœªæä¾› VERCEL_DEPLOY_HOOK_URLï¼Œå°‡ç­‰å¾… Vercel å¾ GitHub è‡ªå‹•éƒ¨ç½²"
fi

# ====== 4) å¥åº·æª¢æŸ¥ ======
echo "â€” ç­‰å€™ 60 ç§’è®“éƒ¨ç½²å®Œæˆ..."
sleep 60

fail=0
echo
echo "== å¥åº·æª¢æŸ¥ =="

echo "[1/4] GET https://${DOMAIN}/login æ‡‰ 200/OKï¼ˆé é¢å­˜åœ¨ï¼‰"
code=$(curl -s -o /dev/null -w "%{http_code}" "https://${DOMAIN}/login")
echo "  â†³ å›æ‡‰ç¢¼ï¼š$code"
[[ "$code" == "200" ]] || { echo "  âœ— é é¢æœªå°±ç·’"; fail=$((fail+1)); }

echo "[2/4] POST https://${DOMAIN}/api/checkin/create æ‡‰ç”±ä¸»ç·šè™•ç†ï¼ˆ200/401/403 çš†å¯æ¥å—ï¼›ä¸æ‡‰è©² 404/500ï¼‰"
code=$(curl -s -o /dev/null -w "%{http_code}" -X POST "https://${DOMAIN}/api/checkin/create" \
  -H "Content-Type: application/json" -d '{"probe":"m7-final"}')
echo "  â†³ å›æ‡‰ç¢¼ï¼š$code"
case "$code" in
  200|401|403) echo "  âœ“ ä¸»ç·šç«¯é»å­˜åœ¨";;
  *) echo "  âœ— ä¸é æœŸçš„ç‹€æ…‹ç¢¼ï¼ˆæ‡‰é 404/500ï¼‰"; fail=$((fail+1));;
esac

echo "[3/4] GET https://${DOMAIN}/api/checkin æ‡‰ 404ï¼ˆå·²æ¸…ç†èˆŠç«¯é»ï¼‰"
code=$(curl -s -o /dev/null -w "%{http_code}" "https://${DOMAIN}/api/checkin")
echo "  â†³ å›æ‡‰ç¢¼ï¼š$code"
[[ "$code" == "404" ]] && echo "  âœ“ èˆŠç«¯é»å·²æ¸…" || { echo "  âœ— èˆŠç«¯é»å°šå­˜åœ¨ï¼ˆé æœŸ 404ï¼‰"; fail=$((fail+1)); }

echo "[4/4] GET https://${DOMAIN}/api/login æ‡‰ 404ï¼ˆå·²æ¸…ç†èˆŠç«¯é»ï¼‰"
code=$(curl -s -o /dev/null -w "%{http_code}" "https://${DOMAIN}/api/login")
echo "  â†³ å›æ‡‰ç¢¼ï¼š$code"
[[ "$code" == "404" ]] && echo "  âœ“ èˆŠç«¯é»å·²æ¸…" || { echo "  âœ— èˆŠç«¯é»å°šå­˜åœ¨ï¼ˆé æœŸ 404ï¼‰"; fail=$((fail+1)); }

echo
if [ $fail -eq 0 ]; then
  echo "ğŸ‰ M7-Final Clean é©—æ”¶é€šéï¼šæ–°ä¸»ç·šæ­£å¸¸ã€èˆŠç«¯é»å·²ç§»é™¤ã€ç’°å¢ƒè®Šæ•¸å°±ä½ã€‚"
  exit 0
else
  echo "âš ï¸ M7-Final Clean éƒ¨åˆ†æª¢æŸ¥æœªé€šéï¼Œè«‹ä¾ä¸Šæ–¹ âœ— æç¤ºä¿®æ­£å¾Œå†è·‘ä¸€æ¬¡ã€‚"
  exit 2
fi