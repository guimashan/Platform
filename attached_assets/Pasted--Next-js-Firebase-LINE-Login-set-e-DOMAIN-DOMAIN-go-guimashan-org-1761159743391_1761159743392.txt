# === 第二階段：奉香簽到系統初始化（Next.js + Firebase + LINE Login） ===
set -e

DOMAIN="${DOMAIN:-go.guimashan.org.tw}"
BRANCH="${BRANCH:-main}"

echo "== 1) 建立 Next.js API 路由與頁面 =="

mkdir -p src/app/api/checkin src/app/api/checkin/manage src/app/api/login
mkdir -p src/app/checkin src/app/checkin/manage

# /api/login  LINE 登入
cat > src/app/api/login/route.ts <<'TS'
import { NextRequest } from "next/server"
export async function GET(req: NextRequest) {
  const url = new URL(req.url)
  const redirect = url.searchParams.get("redirect") || "/checkin"
  const loginUrl = `https://access.line.me/oauth2/v2.1/authorize?response_type=code&client_id=${process.env.LINE_CHANNEL_ID}&redirect_uri=${process.env.NEXT_PUBLIC_LINE_CALLBACK_URL}&state=login&scope=profile%20openid%20email`
  return Response.redirect(loginUrl)
}
TS

# /api/checkin  奉香簽到
cat > src/app/api/checkin/route.ts <<'TS'
import { NextRequest } from "next/server"
import { initializeApp, getApps, cert } from "firebase-admin/app"
import { getFirestore } from "firebase-admin/firestore"
if (!getApps().length) initializeApp({ credential: cert(JSON.parse(process.env.FIREBASE_SERVICE_ACCOUNT_JSON || "{}")) })
const db = getFirestore()

export async function POST(req: NextRequest) {
  const body = await req.json()
  const record = { userId: body.userId, name: body.name, time: new Date().toISOString() }
  await db.collection("checkins").add(record)
  return Response.json({ ok: true, message: "奉香簽到完成", record })
}
TS

# /api/checkin/manage  奉香管理
cat > src/app/api/checkin/manage/route.ts <<'TS'
import { getApps, cert, initializeApp } from "firebase-admin/app"
import { getFirestore } from "firebase-admin/firestore"
if (!getApps().length) initializeApp({ credential: cert(JSON.parse(process.env.FIREBASE_SERVICE_ACCOUNT_JSON || "{}")) })
const db = getFirestore()
export async function GET() {
  const snap = await db.collection("checkins").orderBy("time", "desc").limit(20).get()
  const data = snap.docs.map(d => d.data())
  return Response.json({ ok: true, data })
}
TS

echo "== 2) 提交到 GitHub =="
git add -A
git commit -m "feat(checkin): initialize new Check-in system (v2)"
git push origin "$BRANCH"

echo "== 3) 觸發 Vercel 部署 =="
curl -fsSL -X POST "https://api.vercel.com/v1/integrations/deploy/prj_7vgOxyOJ2xVYWbODegHjj3bCVxzR/GGrujuMK3Y" || true

echo "== 4) 等候 45 秒後檢查端點狀態 =="
sleep 45
for ep in api/checkin api/checkin/manage api/login; do
  echo "-- 檢查 https://${DOMAIN}/${ep} --"
  curl -sS "https://${DOMAIN}/${ep}" | head -c 300 || true
  echo -e "\n"
done